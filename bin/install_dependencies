#!/usr/bin/env bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

[ "$(whoami)" != 'root' ] && ( echo ERROR: run as root user; exit 1 )

typeset release_path=$(pwd)

typeset bosh_dir=${BOSH_DIR:-/bosh}

apt-get update
apt-get install -y --force-yes build-essential flex bison upstart runit patch g++ libxml2-dev \
  libxslt-dev libpq-dev git-core libsqlite3-dev vim curl unzip libreadline5-dev

# install ruby and dependencies
apt-get install m4 libtool autoconf automake -y

sm set install all
for package in openssl ncurses pkg-config readline zlib libyaml
do
  sm ${package} package install
done
sm ruby install


if [[ ! -d /home/vcap ]]
then
  bosh_users_password=vcap
  /usr/sbin/addgroup --system admin
  /usr/sbin/adduser --disabled-password --gecos Ubuntu vcap
  echo "vcap:${bosh_users_password}" | /usr/sbin/chpasswd
  echo "root:${bosh_users_password}" | /usr/sbin/chpasswd

  for grp in admin adm audio cdrom dialout floppy video plugdev dip
  do
    /usr/sbin/adduser vcap $grp
  done
fi

echo "export PATH=/var/vcap/bosh/bin:\$PATH" >> /root/.bashrc
echo "export PATH=/var/vcap/bosh/bin:\$PATH" >> /home/vcap/.bashrc
if [[ -d /home/vagrant ]]
then
  echo "export PATH=/var/vcap/bosh/bin:\$PATH" >> /home/vagrant/.bashrc
fi

if [[ -x /var/vcap/bosh/bin/monit ]]
then
  /var/vcap/bosh/bin/monit -V
else
  export build_dir=/bosh/agent/misc/stemcell/build2/
  typeset work_path="/"
  export chroot="/"
  ${build_dir}/stages/bosh_monit/apply.sh ${work_path} || exit 1
fi

