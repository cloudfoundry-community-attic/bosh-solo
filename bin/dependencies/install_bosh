#!/usr/bin/env bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

typeset bosh_install_path=${extension_args[1]:-/bosh}

# Based off bosh sha 73148848e0c116e09cc1561cbd47167b06e582c8
# which includes bosh_cli 1.0.rc1
# plus patches:
# - http://reviews.cloudfoundry.org/#/c/10153/ - Templates can access raw_properties (no openstruct wrapper)

if [[ -d ${bosh_install_path} ]]
then
  echo "Updating existing project..."
  cd ${bosh_install_path}
  git pull origin master
else
  echo "Cloning..."
  mkdir -p $(dirname ${bosh_install_path})
  git clone git://github.com/drnic/bosh.git ${bosh_install_path} -b bosh-solo-patches
fi

cd ${bosh_install_path}
rake bundle_install

# need to install some package gems
for package in common cli
do
  cd ${bosh_install_path}/${package}
  bundle install --local --without development production
  rake install
done
